<html>
	<head>
		<title>Starting Code for 1st Project 2017 - with lights and textures</title>
		<style>
		
		body {
			font-family: Monospace;
			background-color: #f0f0f0;
			margin: 0px;
			overflow: hidden;
		}
		
		canvas { 
			width: 100%; 
			height: 100%;
		}
	
	</style>
		<script src="lib/three.min.js"></script>
		<script src="lib/stats.min.js"></script>
		<script src="lib/Coordinates.js"></script>
		<script src="lib/OrbitControls.js"></script>
	</head>
	<body>
		
		<script>
		
		var scene, camera, renderer, controls, stats;

		var startedTime = 0;
		var accelerazioneTreno = 0.1;
		var angolotreno=0;

		//variabili per traversine treno
		var modello_traversinetreno, ferrovia;
		var traversinetreno_geometry, traversinetreno_material, traversinatreno_texture, traversinatreno, traversinetreno;
		var rotaie_geometry, rotaie_material, rotaia1, rotaia2;;

		// variabili per mulino
		var mulino;
		var palomulino_geometry, palomulino_texture, palomulino_material, palimulino;
		var traversinamulino_geometry, traversinemulino;
		var basemulino_geometry, basemulino;
		var bloccomulino_geometry, bloccomulino_texture, bloccomulino_material, bloccomulino;
		var bloccomulino2_geometry, bloccomulino2_texture, bloccomulino2_material, bloccomulino2;
		var vincolo_base_mulino;
		var vincolo_pale_mulino;
		var codamulino_geometry, pernomulino_geometry, codamulino, pernomulino;
		var palamulino_geometry, palamulino_texture, palamulino_material, palemulino;
		var periodo_rotazione_blocco=8; // in secondi, periodo di rotazione blocco+pale

		//variabili per treno
		var treno;
		var locomotiva_geometry, locomotiva_material, locomotiva;
		var ruota_geometry, ruota_material, ruota;
		var cabina_geometry, cabina_material, cabina;
		var tettocabina_geometry, tettocabina_material, tettocabina;
		var camino_geometry, camino_material, camino;
		var zavorra_geometry, zavorra_material, zavorra;
		

		
		function Start() {
			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );

			renderer = new THREE.WebGLRenderer( {antialias: true} );
			renderer.setSize( window.innerWidth, window.innerHeight );
			renderer.setClearColor( 0xa4effc );
			renderer.setPixelRatio( window.devicePixelRatio );
			renderer.gammaInput = true;
			renderer.gammaOutput = true;
			renderer.shadowMap.enabled = true;
			document.body.appendChild( renderer.domElement );
			
			camera.position.set(20,20,60);
			camera.lookAt( new THREE.Vector3(0,0,0));
			
			/*
			var geometry = new THREE.BoxGeometry(1,1,1);
			var texture = THREE.ImageUtils.loadTexture('textures/legno_pali.jpg');
			var material = new THREE.MeshPhongMaterial( { map: texture } );
			var cube = new THREE.Mesh( geometry, material );
			cube.castShadow = true;
			cube.receiveShadow = true;
			
			scene.add( cube );

			var cube2 = new THREE.Mesh(geometry, material);
			cube2.position.set(3,4,5);
			scene.add(cube2);
*/
			var placeholder_material = new THREE.MeshBasicMaterial( { color: 0x000000 } );

			//placeholder mulino
			/*
			var placeholder1_geometry = new THREE.BoxGeometry(10,25,10);
			
			var placeholder1 = new THREE.Mesh(placeholder1_geometry, placeholder_material);
			placeholder1.position.set(0,12.5,0);
			scene.add(placeholder1);
			*/

			//////////////////////////////////////////////////////////// MULINO
			mulino = new THREE.Object3D();

			palomulino_geometry = new THREE.BoxGeometry(3,20,3);
			palomulino_texture = THREE.ImageUtils.loadTexture('textures/legno_pali.jpg');
			palomulino_material = new THREE.MeshPhongMaterial( { map: palomulino_texture } );
			palimulino=[];
			for(i=0; i<4; i++) {
				palimulino[i] =  new THREE.Mesh(palomulino_geometry, palomulino_material);
				mulino.add(palimulino[i]);
			}
			palimulino[0].position.set(4,10,4);
			palimulino[1].position.set(4,10,-4);
			palimulino[2].position.set(-4,10,4);
			palimulino[3].position.set(-4,10,-4);

			traversinamulino_geometry = new THREE.BoxGeometry(1,18,1);
			traversinemulino=[];
			for(i=0; i<4; i++) {
				traversinemulino[i] =  new THREE.Mesh(traversinamulino_geometry, palomulino_material);
				mulino.add(traversinemulino[i]);
			}
			traversinemulino[0].position.set(4,10,0);
			traversinemulino[0].rotation.x = 20*Math.PI/180;
			traversinemulino[1].position.set(-4,10,0);
			traversinemulino[1].rotation.x = -20*Math.PI/180;
			traversinemulino[2].position.set(0,10,4);
			traversinemulino[2].rotation.z = 20*Math.PI/180;
			traversinemulino[3].position.set(0,10,-4);
			traversinemulino[3].rotation.z = -20*Math.PI/180;

			basemulino_geometry = new THREE.BoxGeometry(13,3,13);
			basemulino = new THREE.Mesh(basemulino_geometry, palomulino_material);
			basemulino.position.set(0, 21.5, 0);
			mulino.add(basemulino);

			bloccomulino_geometry = new THREE.BoxGeometry(3,3,3);
			bloccomulino_texture = THREE.ImageUtils.loadTexture('textures/legno_bloccomulino.jpg');
			bloccomulino_material = new THREE.MeshPhongMaterial( { map: bloccomulino_texture } );
			bloccomulino = new THREE.Mesh(bloccomulino_geometry, bloccomulino_material);
			bloccomulino.position.set(0, 23, 0);
			mulino.add(bloccomulino);

			bloccomulino2_geometry = new THREE.BoxGeometry(24,2,2);
			bloccomulino2_texture = THREE.ImageUtils.loadTexture('textures/legno_bloccomulino2.jpg');
			bloccomulino2_material = new THREE.MeshPhongMaterial( { map: bloccomulino2_texture } );
			bloccomulino2 = new THREE.Mesh(bloccomulino2_geometry, bloccomulino2_material);
			bloccomulino2.position.set(0, 25.5, 0);
			bloccomulino2.rotation.y = 90*Math.PI/180;

			vincolo_base_mulino = new THREE.Object3D();
			scene.add(vincolo_base_mulino);
			vincolo_base_mulino.add(bloccomulino2);
			mulino.add(vincolo_base_mulino);


			codamulino_geometry = new THREE.BoxGeometry(4,6,4);
			codamulino = new THREE.Mesh(codamulino_geometry, bloccomulino_material);
			codamulino.position.set(0, 27, -10.5);
			vincolo_base_mulino.add(codamulino);

			pernomulino_geometry = new THREE.BoxGeometry(3,3,3);
			pernomulino = new THREE.Mesh(pernomulino_geometry, bloccomulino_material);
			pernomulino.position.set(0, 25.5, 12);
			vincolo_base_mulino.add(pernomulino);

			vincolo_pale_mulino = new THREE.Object3D();
			scene.add(vincolo_pale_mulino);

			palamulino_geometry = new THREE.BoxGeometry(1.3,15,1.3);
			palamulino_texture = THREE.ImageUtils.loadTexture('textures/legno_pale.jpg');
			palamulino_material = new THREE.MeshPhongMaterial( { map: palamulino_texture } );
			palemulino=[];

			var num_pale = 12;
			for(i=0; i<num_pale; i++) {
				palemulino[i] = new THREE.Mesh(palamulino_geometry, palamulino_material);
				palemulino[i].rotation.z = i*(360/num_pale)*Math.PI/180;
				vincolo_pale_mulino.add(palemulino[i]);
			}

			vincolo_pale_mulino.position.set(0, 25.5, 12);

			vincolo_base_mulino.add(vincolo_pale_mulino);
			vincolo_base_mulino.rotation.y = -45*Math.PI/180;

			scene.add(mulino);
			//mulino.position.set(20, 0, 20);


			//////////////////////////////////////////////////////////// TRAVERSINE TRENO
			ferrovia = new THREE.Object3D();
			modello_traversinetreno = new THREE.Object3D();

			traversinetreno_geometry = new THREE.BoxGeometry(6,1,1);
			traversinetreno_texture = THREE.ImageUtils.loadTexture('textures/legno_traversinetreno.jpg');
			traversinetreno_material = new THREE.MeshPhongMaterial( { map: traversinetreno_texture } );
			traversinatreno = new THREE.Mesh( traversinetreno_geometry, traversinetreno_material );

			rotaie_geometry = new THREE.BoxGeometry(1,0.5,2.5);
			rotaie_material = new THREE.MeshBasicMaterial( { color: 0x000000 } );
			rotaia1 = new THREE.Mesh( rotaie_geometry, rotaie_material );
			rotaia1.position.set(2,0,1);
			rotaia2 = new THREE.Mesh( rotaie_geometry, rotaie_material );
			rotaia2.position.set(-2,0,1);

			modello_traversinetreno.add(rotaia1);
			modello_traversinetreno.add(rotaia2);
			modello_traversinetreno.add(traversinatreno);
			traversinetreno=[];

			var num_traversine = 100;
			for(var i=0; i<num_traversine; i++) {
				traversinetreno[i] = modello_traversinetreno.clone();
				traversinetreno[i].rotation.y = i*(360/num_traversine)*Math.PI/180;
				traversinetreno[i].position.set(42*Math.cos(i*(360/num_traversine)*Math.PI/180), -0.5, -33*Math.sin(i*(360/num_traversine)*Math.PI/180));
				ferrovia.add(traversinetreno[i]);
			}
			scene.add(ferrovia);

			//ferrovia.position.set(20,0,20);



//-----------------------------------------------------------------------------------CASA
			var casa_geometry = new THREE.BoxGeometry(25,15,10);
			var casa_texture = THREE.ImageUtils.loadTexture('textures/legno_pali.jpg');
			var casa_material = new THREE.MeshPhongMaterial( { map: casa_texture } );
			casa = new THREE.Mesh(casa_geometry, casa_material);
			casa.position.set(40,7.5,-35);
			casa.rotation.y = -30*Math.PI/180;
			scene.add(casa);


			var tetto1_geometry = new THREE.BoxGeometry(25,2,15);
			var tetto1_texture = THREE.ImageUtils.loadTexture('textures/legno_pali.jpg');
			var tetto1_material = new THREE.MeshPhongMaterial( { map: tetto1_texture } );
			tetto1 = new THREE.Mesh(tetto1_geometry, tetto1_material);
			tetto1.position.set(50,15,-30);
			tetto1.rotation.y = -30*Math.PI/180;
			tetto1.rotation.z = -30*Math.PI/180;
			scene.add(tetto1);


			var tetto2_geometry = new THREE.BoxGeometry(25,2,15);
			var tetto2_texture = THREE.ImageUtils.loadTexture('textures/legno_pali.jpg');
			var tetto2_material = new THREE.MeshPhongMaterial( { map: tetto2_texture } );
			tetto2 = new THREE.Mesh(tetto2_geometry, tetto2_material);
			tetto2.position.set(30,15,-40);
			tetto2.rotation.y = -30*Math.PI/180;
			tetto2.rotation.z = 30*Math.PI/180;
			scene.add(tetto2);
	
			var porta_geometry = new THREE.BoxGeometry(5,10,1);
			var porta_texture = THREE.ImageUtils.loadTexture('textures/porta.jpg');
			var porta_material = new THREE.MeshPhongMaterial( { map: porta_texture } );
			porta = new THREE.Mesh(porta_geometry, porta_material);
			porta.position.set(35,5,-30);
			porta.rotation.y = -30*Math.PI/180;
			scene.add(porta);


			var finestra_geometry = new THREE.BoxGeometry(5,5,0.5);
			var finestra_texture = THREE.ImageUtils.loadTexture('textures/finestra.jpg');
			var finestra_material = new THREE.MeshPhongMaterial( { map: finestra_texture } );
			finestra = new THREE.Mesh(finestra_geometry, finestra_material);
			finestra.position.set(43,10,-27);
			finestra.rotation.y = -30*Math.PI/180;
			scene.add(finestra);


			var asta_geometry = new THREE.BoxGeometry(1,15,1);
			var asta_texture = THREE.ImageUtils.loadTexture('textures/legno_pale.jpg');
			var asta_material = new THREE.MeshPhongMaterial( { map: asta_texture } );
			asta = new THREE.Mesh(asta_geometry, asta_material);
			asta.position.set(40,7.5,-15);
			asta.rotation.y = -30*Math.PI/180;
			scene.add(asta);


			var puntaAsta_geometry = new THREE.BoxGeometry(1.5,1.5,1.5);
			var puntaAsta_material = new THREE.MeshBasicMaterial( { color: 0xffd700 } );
			puntaAsta = new THREE.Mesh(puntaAsta_geometry, puntaAsta_material);
			puntaAsta.position.set(40,15,-15);
			puntaAsta.rotation.y = -30*Math.PI/180;
			scene.add(puntaAsta);


            var bandiera_geometry = new THREE.BoxGeometry(10,5,0.5);
			var bandiera_texture = THREE.ImageUtils.loadTexture('textures/bandiera.jpg');
			var bandiera_material = new THREE.MeshPhongMaterial( { map: bandiera_texture } );
			bandiera = new THREE.Mesh(bandiera_geometry, bandiera_material);
			bandiera.position.set(44,12,-12.5);
			bandiera.rotation.y = -30*Math.PI/180;
			scene.add(bandiera);

//-----------------------------------------------------------------------------------FINE CASA


//-----------------------------------------------------------------------------------OMINO

			var gambaL_geometry = new THREE.BoxGeometry(0.5,4,0.5);
			var gambaL_material = new THREE.MeshBasicMaterial( { color: 0xFFE4E1 } );
			gambaL = new THREE.Mesh(gambaL_geometry, gambaL_material);
			gambaL.position.set(41,2,-5);
			scene.add(gambaL);

			var gambaR_geometry = new THREE.BoxGeometry(0.5,4,0.5);
			var gambaR_material = new THREE.MeshBasicMaterial( { color: 0xFFE4E1 } );
			gambaR = new THREE.Mesh(gambaR_geometry, gambaR_material);
			gambaR.position.set(42,2,-5);
			scene.add(gambaR);

			var torso_geometry = new THREE.BoxGeometry(2,3,2);
			var torso_texture = THREE.ImageUtils.loadTexture('textures/orange.jpg');
			var torso_material = new THREE.MeshPhongMaterial( { map: torso_texture } );
			torso = new THREE.Mesh(torso_geometry, torso_material);
			torso.position.set(41.5,4,-5);
			scene.add(torso);

			var testa_geometry = new THREE.BoxGeometry(1,1,1);
			var testa_material = new THREE.MeshBasicMaterial( { color: 0xFFE4E1 } );
			testa = new THREE.Mesh(testa_geometry, testa_material);
			testa.position.set(41.5,6,-5);
			scene.add(testa);

			var braccioL_geometry = new THREE.BoxGeometry(0.5,4,0.5);
			var braccioL_material = new THREE.MeshBasicMaterial( { color: 0xFFE4E1 } );
			braccioL = new THREE.Mesh(braccioL_geometry, braccioL_material);
			braccioL.position.set(40,3.5,-5);
			braccioL.rotation.z = -30*Math.PI/180;
			scene.add(braccioL);

			var braccioR_geometry = new THREE.BoxGeometry(0.5,4,0.5);
			var braccioR_material = new THREE.MeshBasicMaterial( { color: 0xFFE4E1 } );
			braccioR = new THREE.Mesh(braccioR_geometry, braccioR_material);
			braccioR.position.set(43,3.5,-5);
			braccioR.rotation.z = 30*Math.PI/180;
			scene.add(braccioR);

			var cappello_geometry = new THREE.BoxGeometry(2.5,0.5,2.5);
			var cappello_texture = THREE.ImageUtils.loadTexture('textures/orange.jpg');
			var cappello_material = new THREE.MeshPhongMaterial( { map: cappello_texture } );
			cappello = new THREE.Mesh(cappello_geometry, cappello_material);
			cappello.position.set(41.5,6.5,-5);
			scene.add(cappello);

			var punta_geometry = new THREE.BoxGeometry(1,1,1);
			var punta_texture = THREE.ImageUtils.loadTexture('textures/orange.jpg');
			var punta_material = new THREE.MeshPhongMaterial( { map: punta_texture } );
			punta = new THREE.Mesh(punta_geometry, punta_material);
			punta.position.set(41.5,7,-5);
			scene.add(punta);


//-----------------------------------------------------------------------------------FINE OMINO


//-----------------------------------------------------------------------------------TRENO

			treno = new THREE.Object3D();

			locomotiva_geometry = new THREE.BoxGeometry(12,4,8);
			locomotiva_material = new THREE.MeshBasicMaterial({color:0x00ff00});
			locomotiva = new THREE.Mesh(locomotiva_geometry, locomotiva_material);
			locomotiva.position.set(0,4,0);
			treno.add(locomotiva);

			ruota_geometry = new THREE.BoxGeometry(2,2,2);
			ruota_material = new THREE.MeshBasicMaterial({color:0xff0000});
			ruota = [];
			for (i=0; i<4; i++){
				ruota[i] = new THREE.Mesh(ruota_geometry, ruota_material);
				treno.add(ruota[i]);
			}
			ruota[0].position.set(-5,1,2);
			ruota[1].position.set(-5,1,-2);
			ruota[2].position.set(3,1,2);
			ruota[3].position.set(3,1,-2);

			cabina_geometry = new THREE.BoxGeometry(6,4,8);
			cabina_material = new THREE.MeshBasicMaterial({color:0x0000ff});
			cabina = new THREE.Mesh(cabina_geometry,cabina_material);
			cabina.position.set(-3,8,0);
			treno.add(cabina);

			tettocabina_geometry = new THREE.BoxGeometry(8,1,10);
			tettocabina_material = new THREE.MeshBasicMaterial({color:0xff0000});
			tettocabina = new THREE.Mesh(tettocabina_geometry,tettocabina_material);
			tettocabina.position.set(-3,10.5,0);
			treno.add(tettocabina);

			camino_geometry = new THREE.BoxGeometry(2,4,2);
			camino_material = new THREE.MeshBasicMaterial({color:0x00ffff});
			camino = new THREE.Mesh(camino_geometry,camino_material);
			camino.position.set(3.5,8,0);
			treno.add(camino);

			zavorra_geometry = new THREE.BoxGeometry(2,2,8);
			zavorra_material = new THREE.MeshBasicMaterial({color:0xa4effc});
			zavorra = new THREE.Mesh(zavorra_geometry,zavorra_material);
			zavorra.position.set(7,3,0);
			treno.add(zavorra);

			treno.position.set(0,0,33);
			//treno.rotation.y=180*Math.PI/180;

			//scene.add(treno);
			ferrovia.add(treno);

//-----------------------------------------------------------------------------------FINE TRENO


			hemiLight = new THREE.HemisphereLight( 0xffffff, 0xffffff, 0.6 );
			hemiLight.color.setHSL( 0.6, 1, 0.6 );
			hemiLight.groundColor.setHSL( 0.095, 1, 0.75 );
			hemiLight.position.set( 0, 500, 0 );
			scene.add( hemiLight );

			dirLight = new THREE.DirectionalLight( 0xffffff, 1 );
			dirLight.color.setHSL( 0.1, 1, 0.95 );
			dirLight.position.set( -1, 1.75, 1 );
			dirLight.position.multiplyScalar( 50 );
			scene.add( dirLight );
			dirLight.castShadow = true;
			dirLight.shadow.mapSize.width = 1024;
			dirLight.shadow.mapSize.height = 1024;


			// GROUND
			var groundGeo = new THREE.PlaneBufferGeometry( 130, 100 );
			var text = THREE.ImageUtils.loadTexture('textures/deadGrass.jpg');
			var groundMat = new THREE.MeshPhongMaterial( { map: text } );
			//var groundMat = new THREE.MeshPhongMaterial( { color: 0xffffff, specular: 0x050505 } );
			groundMat.color.setHSL( 0.095, 1, 0.75 );
			var ground = new THREE.Mesh( groundGeo, groundMat );
			ground.position.y = -0.5;
			ground.rotation.x = -Math.PI/2;
			scene.add( ground );
			ground.receiveShadow = true;
			
			stats = new Stats();
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			document.body.appendChild( stats.domElement );
			
			// uncomment if you need to draw coordinate axes when building the scene
			//Coordinates.drawAllAxes();
			
			controls = new THREE.OrbitControls( camera );
			controls.addEventListener( 'change', Render );
			
			startedTime=Date.now();
			
		}
		
		function Update() {
			cinematicaMulino();
			cinematicaTreno();
			requestAnimationFrame( Update );
			controls.update();  
			stats.update();
			Render();
		}
		
		function Render() {
			
			renderer.render(scene, camera);
		}

		function cinematicaMulino() {
			var elapsed=(Date.now()-startedTime)/1000;
			if(elapsed>periodo_rotazione_blocco) {
				startedTime=Date.now();
			}
			var accelerazione=Math.sin((360/periodo_rotazione_blocco)*elapsed*Math.PI/180);
			vincolo_base_mulino.rotation.y += accelerazione*1*Math.PI/180;
			vincolo_pale_mulino.rotation.z += accelerazione*5*Math.PI/180;
		}
		function cinematicaTreno() {
			treno.rotation.y=(angolotreno+90)*Math.PI/180;
			treno.position.set(41.5*Math.cos(angolotreno*Math.PI/180), 0, -32.5*Math.sin(angolotreno*Math.PI/180));
			angolotreno=angolotreno+accelerazioneTreno;
		}
		
		Start();
		Update();

		//window.addEventListener("accelerazioniTreno", accelerazioniTreno, false);
		document.onkeydown = accelerazioniTreno;
		function accelerazioniTreno(e){
			var keyCode = e.keyCode;
			if(keyCode == 87){
				accelerazioneTreno=accelerazioneTreno+0.1;
			}
			if(keyCode == 83){
				if(accelerazioneTreno<0.3) {
					accelerazioneTreno=0;
				} else {
					accelerazioneTreno=accelerazioneTreno-0.3;
				}
			}
		};
		</script>

	</body>
</html>